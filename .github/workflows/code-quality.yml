name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci
      
      - name: Check code formatting
        run: |
          npm run format:check || echo "Code formatting issues found"
      
      - name: Lint client code
        run: cd client && npm run lint
      
      - name: Lint server code
        run: cd server && npm run lint
      
      - name: Type check client
        run: cd client && npm run typecheck || echo "Client type checking issues found"
      
      - name: Type check server
        run: cd server && npm run typecheck || echo "Server type checking issues found"
      
      # Uncomment when you have tests set up
      # - name: Run tests with coverage
      #   run: |
      #     cd client && npm run test:coverage
      #     cd ../server && npm run test:coverage
      
      # - name: Upload coverage reports to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     directory: ./coverage/
      #     fail_ci_if_error: true
      
      - name: Check for TypeScript linter errors in API controllers
        run: |
          cd server
          echo "Checking for TypeScript linter errors in controller return types..."
          grep -r "Promise<Response" src/controllers || echo "No controller return type issues found" 