name: API Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/src/**'
      - 'project_setup.js'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'server/src/**'
      - 'project_setup.js'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  validate-api:
    runs-on: ubuntu-latest
    
    services:
      # Set up MongoDB service container
      mongodb:
        image: mongo:4.4
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        options: >-
          --health-cmd "mongo --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          npm install dotenv mongoose
      
      - name: Start server in background
        run: |
          cd server
          PORT=8080 NODE_ENV=test MONGO_URI=mongodb://admin:password@localhost:27017/church-planner-test?authSource=admin JWT_SECRET=test_jwt_secret_for_ci JWT_EXPIRE=1d npm run dev &
          sleep 10 # Give the server time to start
      
      - name: Run API validation script
        run: |
          chmod +x project_setup.js
          NODE_ENV=test PORT=8080 node project_setup.js
        env:
          MONGO_URI: mongodb://admin:password@localhost:27017/church-planner-test?authSource=admin
          JWT_SECRET: test_jwt_secret_for_ci
          JWT_EXPIRE: 1d 